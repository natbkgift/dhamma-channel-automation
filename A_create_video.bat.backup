@echo off
chcp 65001 >nul
REM ========================================
REM Dhamma Video Creation - Full Workflow
REM Path A (Manual/Free)
REM ========================================

echo.
echo â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
echo â•‘  ğŸ¬ Dhamma Video Creation Workflow - Path A                   â•‘
echo â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo.

REM ========================================
REM Step 0: Check and Select Next Topic
REM ========================================
echo ğŸ” Checking Mock Topics Database...
echo.

REM Check if mock topics exist
if not exist "data\mock_topics.json" (
    echo âŒ ERROR: Mock topics not found!
    echo.
    echo ğŸ’¡ Running generate_mock_topics.bat to create new topics...
    echo.
    call generate_mock_topics.bat
    if %errorlevel% neq 0 (
        echo âŒ Failed to generate topics!
        pause
        exit /b 1
    )
)

REM Get next topic (highest priority that hasn't been done)
for /f "usebackq delims=" %%i in (`"%~dp0venv\Scripts\python.exe" scripts\topic_database.py --topics data\mock_topics.json --history data\production_history.json next --title-only`) do set "TOPIC_TITLE=%%i"

if "%TOPIC_TITLE%"=="" (
    echo ğŸ‰ All topics completed!
    echo.
    echo ï¿½ Generating new topics batch...
    echo.
    call generate_mock_topics.bat
    if %errorlevel% neq 0 (
        echo âŒ Failed to generate new topics!
        pause
        exit /b 1
    )
    
    REM Get next topic from new batch
    for /f "usebackq delims=" %%i in (`"%~dp0venv\Scripts\python.exe" scripts\topic_database.py --topics data\mock_topics.json --history data\production_history.json next --title-only`) do set "TOPIC_TITLE=%%i"
    
    if "%TOPIC_TITLE%"=="" (
        echo âŒ Still no topics available!
        pause
        exit /b 1
    )
)

REM Check priority of selected topic
for /f "usebackq delims=" %%i in (`""%~dp0venv\Scripts\python.exe" scripts\get_topic_priority.py --topics data\mock_topics.json --title "%TOPIC_TITLE%""`) do set "TOPIC_PRIORITY=%%i"

echo âœ… Selected Topic: %TOPIC_TITLE%
echo ï¿½ Priority: %TOPIC_PRIORITY%/10
echo.

REM If priority < 3, regenerate topics and create new report
if %TOPIC_PRIORITY% LSS 3 (
    echo âš ï¸  All high-priority topics ^(â‰¥3^) completed!
    echo ğŸ’¡ Generating new topics batch and creating report...
    echo.
    
    REM Generate new topics and create HTML report
    call generate_mock_topics.bat
    if %errorlevel% neq 0 (
        echo âŒ Failed to generate new topics!
        pause
        exit /b 1
    )
    
    REM Get next topic from new batch
    for /f "usebackq delims=" %%i in (`"%~dp0venv\Scripts\python.exe" scripts\topic_database.py --topics data\mock_topics.json --history data\production_history.json next --title-only`) do set "TOPIC_TITLE=%%i"
    
    if "%TOPIC_TITLE%"=="" (
        echo âŒ No topics available!
        pause
        exit /b 1
    )
    
    for /f "usebackq delims=" %%i in (`""%~dp0venv\Scripts\python.exe" scripts\get_topic_priority.py --topics data\mock_topics.json --title "%TOPIC_TITLE%""`) do set "TOPIC_PRIORITY=%%i"
    
    echo âœ… New Topic: %TOPIC_TITLE%
    echo ğŸ“Š Priority: %TOPIC_PRIORITY%/10
    echo.
)
echo à¸à¸” Enter à¹€à¸à¸·à¹ˆà¸­à¹€à¸£à¸´à¹ˆà¸¡à¸ªà¸£à¹‰à¸²à¸‡à¸§à¸´à¸”à¸µà¹‚à¸­...
pause >nul
echo.

REM Generate run ID with timestamp
for /f "tokens=2-4 delims=/ " %%a in ('date /t') do (set mydate=%%c%%a%%b)
for /f "tokens=1-3 delims=:." %%a in ("%TIME%") do (set mytime=%%a%%b%%c)
set mytime=%mytime: =0%
set RUN_ID=production_%mydate%_%mytime%
echo ğŸ†” Run ID: %RUN_ID%
echo.

REM ========================================
REM Step 1: AI Content Generation (17 Agents)
REM ========================================
echo.
echo â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
echo â•‘  STEP 1/4: AI Content Generation (17 Agents)                  â•‘
echo â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo.
echo ğŸ“ Creating video content using AI agents...
echo ğŸ“Œ Topic: %TOPIC_TITLE%
echo.

"%~dp0venv\Scripts\python.exe" orchestrator.py --pipeline pipelines\video_complete.yaml --run-id %RUN_ID% --topic "%TOPIC_TITLE%"

if %errorlevel% neq 0 (
    echo.
    echo âŒ ERROR: AI Content Generation failed!
    echo    Check the error messages above.
    pause
    exit /b 1
)

echo.
echo âœ… AI Content Generation completed!
echo    Output: output\%RUN_ID%\
echo.
timeout /t 3 >nul

REM ========================================
REM Step 2: Production Assets Generation
REM ========================================
echo.
echo â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
echo â•‘  STEP 2/4: Production Assets Generation (Path A)              â•‘
echo â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo.
echo ğŸ”§ Generating production-ready files...
echo.

"%~dp0venv\Scripts\python.exe" scripts\production_orchestrator.py --input-dir output\%RUN_ID% --path A

if %errorlevel% neq 0 (
    echo.
    echo âŒ ERROR: Production Assets Generation failed!
    echo    Check the error messages above.
    pause
    exit /b 1
)

echo.
echo âœ… Production Assets Generation completed!
echo.
timeout /t 3 >nul

REM ========================================
REM Step 3: Generate HTML Report
REM ========================================
echo.
echo â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
echo â•‘  STEP 3/4: Generating Production Report                       â•‘
echo â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo.

"%~dp0venv\Scripts\python.exe" scripts\generate_production_report.py --run-id %RUN_ID%

if %errorlevel% neq 0 (
    echo.
    echo âš ï¸  WARNING: Report generation failed, but production files are ready.
    echo    You can still proceed with manual production.
)

REM ========================================
REM Step 4: Update Production History
REM ========================================
echo.
echo â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
echo â•‘  STEP 4/4: Updating Production History                        â•‘
echo â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo.

REM Get topic ID from database
for /f "usebackq delims=" %%i in (`"%~dp0venv\Scripts\python.exe" scripts\topic_database.py --topics data\mock_topics.json --history data\production_history.json next --id-only`) do set "TOPIC_ID=%%i"

REM Mark as completed
"%~dp0venv\Scripts\python.exe" scripts\topic_database.py --topics data\mock_topics.json --history data\production_history.json mark --topic-id %TOPIC_ID% --status completed --run-id %RUN_ID% --output-dir output\%RUN_ID%

if %errorlevel% equ 0 (
    echo âœ… Production history updated
) else (
    echo âš ï¸  WARNING: Failed to update history
)

echo.

REM ========================================
REM Completion
REM ========================================
echo.
echo.
echo â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
echo â•‘  ğŸ‰ WORKFLOW COMPLETED SUCCESSFULLY!                          â•‘
echo â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo.
echo ğŸ“‚ Generated Files:
echo    â€¢ AI Content:     output\%RUN_ID%\
echo    â€¢ Audio Scripts:  audio\%RUN_ID%\
echo    â€¢ Video Templates: templates\%RUN_ID%\
echo    â€¢ Thumbnail Guide: templates\canva\
echo    â€¢ ğŸ“„ Production Report: output\%RUN_ID%\PRODUCTION_GUIDE.html
echo.
echo ğŸŒ Opening Production Report...
echo.

REM Open HTML report in default browser
if exist "output\%RUN_ID%\PRODUCTION_GUIDE.html" (
    start "" "output\%RUN_ID%\PRODUCTION_GUIDE.html"
) else (
    echo âš ï¸  Report file not found. Please check output\%RUN_ID%\ folder manually.
)

echo.
echo âœ¨ Next: Follow the steps in PRODUCTION_GUIDE.html
echo.
pause
